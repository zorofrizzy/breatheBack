<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Management Test - BreatheBack</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #state-display {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>BreatheBack State Management Tests</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="displayCurrentState()">Display Current State</button>
        <button onclick="clearStorage()">Clear Storage</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>Current State</h2>
        <div id="state-display"></div>
    </div>

    <!-- Mock navigation elements for testing -->
    <div style="display: none;">
        <div id="report-view"></div>
        <div id="heatmap-view"></div>
        <div id="community-view"></div>
        <div id="mypoints-view"></div>
        <button class="nav-item" data-view="report"></button>
        <button class="nav-item" data-view="heatmap"></button>
        <button class="nav-item" data-view="community"></button>
        <button class="nav-item" data-view="mypoints"></button>
    </div>

    <script src="app.js"></script>
    <script>
        // Test utilities
        function logResult(testName, passed, message = '') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            resultDiv.textContent = `${passed ? '✓' : '✗'} ${testName}${message ? ': ' + message : ''}`;
            resultsDiv.appendChild(resultDiv);
            return passed;
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        function displayCurrentState() {
            const state = window.BreatheBackApp.getState();
            const stateDisplay = document.getElementById('state-display');
            
            // Convert Map to object for display
            const displayState = {
                ...state,
                zones: Array.from(state.zones.entries()).map(([id, zone]) => ({ id, ...zone }))
            };
            
            stateDisplay.textContent = JSON.stringify(displayState, null, 2);
        }

        function clearStorage() {
            localStorage.clear();
            location.reload();
        }

        // Test Suite
        function runAllTests() {
            clearResults();
            let passCount = 0;
            let totalTests = 0;

            // Test 1: Initial state structure
            totalTests++;
            const state = window.BreatheBackApp.getState();
            const hasRequiredFields = state.hasOwnProperty('currentView') &&
                                     state.hasOwnProperty('currentMapType') &&
                                     state.hasOwnProperty('zones') &&
                                     state.hasOwnProperty('userPoints') &&
                                     state.hasOwnProperty('events');
            if (logResult('Initial state has required fields', hasRequiredFields)) passCount++;

            // Test 2: Default view is 'report'
            totalTests++;
            if (logResult('Default view is report', state.currentView === 'report')) passCount++;

            // Test 3: Zones is a Map
            totalTests++;
            if (logResult('Zones is a Map', state.zones instanceof Map)) passCount++;

            // Test 4: Update view function
            totalTests++;
            window.BreatheBackApp.updateView('heatmap');
            const newState = window.BreatheBackApp.getState();
            if (logResult('updateView changes currentView', newState.currentView === 'heatmap')) passCount++;

            // Test 5: Update view back to report
            totalTests++;
            window.BreatheBackApp.updateView('report');
            if (logResult('updateView can change back to report', 
                         window.BreatheBackApp.getState().currentView === 'report')) passCount++;

            // Test 6: Update map type
            totalTests++;
            window.BreatheBackApp.updateMapType('smoke');
            if (logResult('updateMapType changes currentMapType', 
                         window.BreatheBackApp.getState().currentMapType === 'smoke')) passCount++;

            // Test 7: Add a zone
            totalTests++;
            const testZone = {
                id: 'zone_test_123',
                bounds: { north: 40.01, south: 40.00, east: -74.00, west: -74.01 },
                vapeDebt: 10,
                vapeRestore: 5,
                smokeDebt: 20,
                smokeRestore: 15,
                lastUpdated: new Date().toISOString()
            };
            window.BreatheBackApp.updateZone('zone_test_123', testZone);
            const hasZone = window.BreatheBackApp.getState().zones.has('zone_test_123');
            if (logResult('updateZone adds zone to state', hasZone)) passCount++;

            // Test 8: Update user points
            totalTests++;
            const testPoints = {
                date: new Date().toISOString().split('T')[0],
                totalPoints: 50,
                actionsCompleted: 5,
                vapePoints: 30,
                smokePoints: 20,
                actions: []
            };
            window.BreatheBackApp.updatePoints(testPoints);
            const points = window.BreatheBackApp.getState().userPoints;
            if (logResult('updatePoints updates user points', 
                         points && points.totalPoints === 50)) passCount++;

            // Test 9: Update events
            totalTests++;
            const testEvents = [
                {
                    id: 'event_1',
                    name: 'Community Cleanup',
                    location: 'Central Park',
                    dateTime: new Date().toISOString(),
                    duration: 120,
                    typeFocus: 'both',
                    description: 'Test event'
                }
            ];
            window.BreatheBackApp.updateEvents(testEvents);
            const events = window.BreatheBackApp.getState().events;
            if (logResult('updateEvents updates events array', 
                         events && events.length === 1)) passCount++;

            // Test 10: Update location
            totalTests++;
            const testLocation = { latitude: 40.7128, longitude: -74.0060 };
            window.BreatheBackApp.updateLocation(testLocation);
            const location = window.BreatheBackApp.getState().currentLocation;
            if (logResult('updateLocation updates current location', 
                         location && location.latitude === 40.7128)) passCount++;

            // Test 11: Show restoration card
            totalTests++;
            const testReport = {
                type: 'vape',
                context: 'indoor',
                location: testLocation,
                timestamp: new Date()
            };
            window.BreatheBackApp.showRestorationActionCard(testReport);
            const showCard = window.BreatheBackApp.getState().showRestorationCard;
            if (logResult('showRestorationActionCard sets flag', showCard === true)) passCount++;

            // Test 12: Hide restoration card
            totalTests++;
            window.BreatheBackApp.hideRestorationActionCard();
            const hideCard = window.BreatheBackApp.getState().showRestorationCard;
            if (logResult('hideRestorationActionCard clears flag', hideCard === false)) passCount++;

            // Test 13: Storage persistence
            totalTests++;
            window.BreatheBackApp.saveStateToStorage();
            const storedZones = localStorage.getItem('breatheback_zones');
            if (logResult('saveStateToStorage persists zones', storedZones !== null)) passCount++;

            // Test 14: Storage load
            totalTests++;
            window.BreatheBackApp.loadStateFromStorage();
            const loadedState = window.BreatheBackApp.getState();
            if (logResult('loadStateFromStorage retrieves zones', 
                         loadedState.zones.size > 0)) passCount++;

            // Test 15: Invalid view rejection
            totalTests++;
            const beforeView = window.BreatheBackApp.getState().currentView;
            window.BreatheBackApp.updateView('invalid_view');
            const afterView = window.BreatheBackApp.getState().currentView;
            if (logResult('updateView rejects invalid views', beforeView === afterView)) passCount++;

            // Summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `test-result ${passCount === totalTests ? 'pass' : 'fail'}`;
            summaryDiv.innerHTML = `<strong>Summary: ${passCount}/${totalTests} tests passed</strong>`;
            document.getElementById('test-results').appendChild(summaryDiv);

            // Display final state
            displayCurrentState();
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('Running automated tests...');
                runAllTests();
            }, 500);
        });
    </script>
</body>
</html>
