<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 21 Checkpoint - Integration Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #ddd;
        }
        .test-case.pass {
            border-left-color: #4CAF50;
            background-color: #f1f8f4;
        }
        .test-case.fail {
            border-left-color: #f44336;
            background-color: #fef1f0;
        }
        .test-case.running {
            border-left-color: #2196F3;
            background-color: #e3f2fd;
        }
        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #1976D2;
        }
        .summary {
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
        }
        .summary.pass {
            color: #4CAF50;
        }
        .summary.fail {
            color: #f44336;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Task 21 Checkpoint - Comprehensive Integration Tests</h1>
    <p>This test suite validates all components and integration flows for the BreatheBack application.</p>
    
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="summary" class="summary"></div>
    
    <div class="test-section">
        <h2>1. Navigation Between Views</h2>
        <div id="nav-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Report → Action → Zone Update Flow</h2>
        <div id="flow-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Heatmap Toggle and Zone Inspection</h2>
        <div id="heatmap-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Points Summary and Daily Reset</h2>
        <div id="points-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Event Creation and Display</h2>
        <div id="event-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>6. Reset Functionality</h2>
        <div id="reset-tests"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };

        function addTestResult(containerId, testName, passed, message = '') {
            const container = document.getElementById(containerId);
            const testCase = document.createElement('div');
            testCase.className = `test-case ${passed ? 'pass' : 'fail'}`;
            testCase.innerHTML = `
                <strong>${passed ? '✓' : '✗'} ${testName}</strong>
                ${message ? `<div style="margin-top: 5px; font-size: 14px;">${message}</div>` : ''}
            `;
            container.appendChild(testCase);
            
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            const passRate = testResults.total > 0 ? 
                ((testResults.passed / testResults.total) * 100).toFixed(1) : 0;
            summary.className = `summary ${testResults.failed === 0 ? 'pass' : 'fail'}`;
            summary.textContent = `Results: ${testResults.passed}/${testResults.total} passed (${passRate}%)`;
        }

        function clearResults() {
            ['nav-tests', 'flow-tests', 'heatmap-tests', 'points-tests', 'event-tests', 'reset-tests']
                .forEach(id => document.getElementById(id).innerHTML = '');
            testResults = { passed: 0, failed: 0, total: 0 };
            updateSummary();
        }

        async function testNavigationViews() {
            try {
                // Test that all API endpoints are accessible
                const endpoints = ['/zones', '/points', '/events'];
                
                for (const endpoint of endpoints) {
                    const response = await fetch(`${API_BASE}${endpoint}`);
                    const passed = response.ok;
                    addTestResult('nav-tests', 
                        `API endpoint ${endpoint} accessible`, 
                        passed,
                        passed ? '' : `Status: ${response.status}`
                    );
                }
            } catch (error) {
                addTestResult('nav-tests', 'Navigation API tests', false, error.message);
            }
        }

        async function testReportActionFlow() {
            try {
                // Reset data first
                await fetch(`${API_BASE}/reset`, { method: 'POST' });
                
                // Step 1: Submit a report
                const reportData = {
                    type: 'vape',
                    context: 'indoor',
                    latitude: 37.7749,
                    longitude: -122.4194
                };
                
                const reportResponse = await fetch(`${API_BASE}/reports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reportData)
                });
                
                const reportResult = await reportResponse.json();
                addTestResult('flow-tests', 
                    'Submit report', 
                    reportResult.success === true,
                    `Zone ID: ${reportResult.zoneId}`
                );
                
                const zoneId = reportResult.zoneId;
                
                // Step 2: Verify zone debt increased
                const zonesResponse = await fetch(`${API_BASE}/zones`);
                const zones = await zonesResponse.json();
                const zone = zones.find(z => z.id === zoneId);
                
                addTestResult('flow-tests', 
                    'Zone debt increased', 
                    zone && zone.vapeDebt === 10,
                    `Vape debt: ${zone ? zone.vapeDebt : 'N/A'}`
                );
                
                // Step 3: Complete restoration action
                const actionData = {
                    actionId: 'indoor_1',
                    points: 10,
                    type: 'vape',
                    zoneId: zoneId
                };
                
                const actionResponse = await fetch(`${API_BASE}/actions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(actionData)
                });
                
                const actionResult = await actionResponse.json();
                addTestResult('flow-tests', 
                    'Complete restoration action', 
                    actionResult.success === true
                );
                
                // Step 4: Verify zone restoration increased
                const zonesResponse2 = await fetch(`${API_BASE}/zones`);
                const zones2 = await zonesResponse2.json();
                const zone2 = zones2.find(z => z.id === zoneId);
                
                addTestResult('flow-tests', 
                    'Zone restoration score increased', 
                    zone2 && zone2.vapeRestore === 10,
                    `Vape restore: ${zone2 ? zone2.vapeRestore : 'N/A'}`
                );
                
                // Step 5: Verify user points increased
                const pointsResponse = await fetch(`${API_BASE}/points`);
                const points = await pointsResponse.json();
                
                addTestResult('flow-tests', 
                    'User points increased', 
                    points.totalPoints === 10,
                    `Total points: ${points.totalPoints}`
                );
                
            } catch (error) {
                addTestResult('flow-tests', 'Report-Action flow', false, error.message);
            }
        }

        async function testHeatmapAndZones() {
            try {
                // Reset data
                await fetch(`${API_BASE}/reset`, { method: 'POST' });
                
                // Create zones with different types
                const reports = [
                    { type: 'vape', latitude: 37.7749, longitude: -122.4194 },
                    { type: 'smoke', latitude: 37.7750, longitude: -122.4195 },
                    { type: 'vape', latitude: 37.7751, longitude: -122.4196 }
                ];
                
                for (const report of reports) {
                    await fetch(`${API_BASE}/reports`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(report)
                    });
                }
                
                // Get all zones
                const zonesResponse = await fetch(`${API_BASE}/zones`);
                const zones = await zonesResponse.json();
                
                addTestResult('heatmap-tests', 
                    'Multiple zones created', 
                    zones.length >= 3,
                    `Zone count: ${zones.length}`
                );
                
                // Test vape/smoke data isolation
                const vapeZone = zones.find(z => z.vapeDebt > 0 && z.smokeDebt === 0);
                const smokeZone = zones.find(z => z.smokeDebt > 0 && z.vapeDebt === 0);
                
                addTestResult('heatmap-tests', 
                    'Vape data isolated', 
                    vapeZone !== undefined,
                    vapeZone ? `Zone ${vapeZone.id}: vapeDebt=${vapeZone.vapeDebt}, smokeDebt=${vapeZone.smokeDebt}` : ''
                );
                
                addTestResult('heatmap-tests', 
                    'Smoke data isolated', 
                    smokeZone !== undefined,
                    smokeZone ? `Zone ${smokeZone.id}: smokeDebt=${smokeZone.smokeDebt}, vapeDebt=${smokeZone.vapeDebt}` : ''
                );
                
                // Test zone structure
                if (zones.length > 0) {
                    const zone = zones[0];
                    const hasRequiredFields = 
                        'id' in zone &&
                        'vapeDebt' in zone &&
                        'vapeRestore' in zone &&
                        'smokeDebt' in zone &&
                        'smokeRestore' in zone;
                    
                    addTestResult('heatmap-tests', 
                        'Zone has required fields', 
                        hasRequiredFields,
                        `Fields: ${Object.keys(zone).join(', ')}`
                    );
                }
                
            } catch (error) {
                addTestResult('heatmap-tests', 'Heatmap tests', false, error.message);
            }
        }

        async function testPointsAndReset() {
            try {
                // Reset data
                await fetch(`${API_BASE}/reset`, { method: 'POST' });
                
                // Complete multiple actions
                const zoneId = 'zone_3774_-12241';
                const actions = [
                    { actionId: 'indoor_1', points: 10, type: 'vape', zoneId },
                    { actionId: 'indoor_2', points: 5, type: 'vape', zoneId },
                    { actionId: 'universal_1', points: 5, type: 'smoke', zoneId }
                ];
                
                for (const action of actions) {
                    await fetch(`${API_BASE}/actions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(action)
                    });
                }
                
                // Check points accumulation
                const pointsResponse = await fetch(`${API_BASE}/points`);
                const points = await pointsResponse.json();
                
                addTestResult('points-tests', 
                    'Points accumulate correctly', 
                    points.totalPoints === 20,
                    `Total: ${points.totalPoints}, Actions: ${points.actionsCompleted}`
                );
                
                addTestResult('points-tests', 
                    'Action count correct', 
                    points.actionsCompleted === 3
                );
                
                // Test vape/smoke breakdown
                addTestResult('points-tests', 
                    'Vape points tracked', 
                    points.vapePoints === 15,
                    `Vape points: ${points.vapePoints}`
                );
                
                addTestResult('points-tests', 
                    'Smoke points tracked', 
                    points.smokePoints === 5,
                    `Smoke points: ${points.smokePoints}`
                );
                
                // Test daily reset
                const resetResponse = await fetch(`${API_BASE}/points/reset`, {
                    method: 'POST'
                });
                const resetResult = await resetResponse.json();
                
                addTestResult('points-tests', 
                    'Points reset successful', 
                    resetResult.success === true
                );
                
                // Verify points are zero
                const pointsAfterReset = await fetch(`${API_BASE}/points`);
                const pointsData = await pointsAfterReset.json();
                
                addTestResult('points-tests', 
                    'Points cleared after reset', 
                    pointsData.totalPoints === 0 && pointsData.actionsCompleted === 0
                );
                
            } catch (error) {
                addTestResult('points-tests', 'Points tests', false, error.message);
            }
        }

        async function testEventCreationAndDisplay() {
            try {
                // Reset data
                await fetch(`${API_BASE}/reset`, { method: 'POST' });
                
                // Create events
                const events = [
                    {
                        name: 'Morning Restoration',
                        location: 'North Zone',
                        dateTime: '2026-02-15T09:00:00',
                        duration: 60,
                        typeFocus: 'vape'
                    },
                    {
                        name: 'Evening Cleanup',
                        location: 'South Zone',
                        dateTime: '2026-02-15T18:00:00',
                        duration: 90,
                        typeFocus: 'smoke',
                        contextHint: 'outdoor'
                    }
                ];
                
                for (const event of events) {
                    const response = await fetch(`${API_BASE}/events`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(event)
                    });
                    const result = await response.json();
                    
                    addTestResult('event-tests', 
                        `Create event: ${event.name}`, 
                        result.success === true,
                        result.eventId ? `Event ID: ${result.eventId}` : ''
                    );
                }
                
                // Retrieve events
                const eventsResponse = await fetch(`${API_BASE}/events`);
                const retrievedEvents = await eventsResponse.json();
                
                addTestResult('event-tests', 
                    'Events retrieved', 
                    retrievedEvents.length >= 2,
                    `Event count: ${retrievedEvents.length}`
                );
                
                // Verify event structure
                if (retrievedEvents.length > 0) {
                    const event = retrievedEvents[0];
                    const hasRequiredFields = 
                        'id' in event &&
                        'name' in event &&
                        'location' in event &&
                        'dateTime' in event &&
                        'typeFocus' in event;
                    
                    addTestResult('event-tests', 
                        'Event has required fields', 
                        hasRequiredFields,
                        `Fields: ${Object.keys(event).join(', ')}`
                    );
                }
                
            } catch (error) {
                addTestResult('event-tests', 'Event tests', false, error.message);
            }
        }

        async function testResetFunctionality() {
            try {
                // Create some data first
                // Submit report
                await fetch(`${API_BASE}/reports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'vape',
                        latitude: 37.7749,
                        longitude: -122.4194
                    })
                });
                
                // Complete action
                await fetch(`${API_BASE}/actions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        actionId: 'indoor_1',
                        points: 10,
                        type: 'vape',
                        zoneId: 'zone_3774_-12241'
                    })
                });
                
                // Create event
                await fetch(`${API_BASE}/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Test Event',
                        location: 'Test Location',
                        dateTime: '2026-02-15T14:00:00',
                        duration: 60,
                        typeFocus: 'both'
                    })
                });
                
                // Verify data exists
                const zonesBefore = await (await fetch(`${API_BASE}/zones`)).json();
                const pointsBefore = await (await fetch(`${API_BASE}/points`)).json();
                const eventsBefore = await (await fetch(`${API_BASE}/events`)).json();
                
                addTestResult('reset-tests', 
                    'Data exists before reset', 
                    zonesBefore.length > 0 && pointsBefore.totalPoints > 0 && eventsBefore.length > 0,
                    `Zones: ${zonesBefore.length}, Points: ${pointsBefore.totalPoints}, Events: ${eventsBefore.length}`
                );
                
                // Perform reset
                const resetResponse = await fetch(`${API_BASE}/reset`, {
                    method: 'POST'
                });
                const resetResult = await resetResponse.json();
                
                addTestResult('reset-tests', 
                    'Reset endpoint successful', 
                    resetResult.success === true
                );
                
                // Verify all data cleared
                const zonesAfter = await (await fetch(`${API_BASE}/zones`)).json();
                const pointsAfter = await (await fetch(`${API_BASE}/points`)).json();
                const eventsAfter = await (await fetch(`${API_BASE}/events`)).json();
                
                addTestResult('reset-tests', 
                    'All zones cleared', 
                    zonesAfter.length === 0,
                    `Zones after reset: ${zonesAfter.length}`
                );
                
                addTestResult('reset-tests', 
                    'All points cleared', 
                    pointsAfter.totalPoints === 0 && pointsAfter.actionsCompleted === 0,
                    `Points: ${pointsAfter.totalPoints}, Actions: ${pointsAfter.actionsCompleted}`
                );
                
                addTestResult('reset-tests', 
                    'All events cleared', 
                    eventsAfter.length === 0,
                    `Events after reset: ${eventsAfter.length}`
                );
                
            } catch (error) {
                addTestResult('reset-tests', 'Reset tests', false, error.message);
            }
        }

        async function runAllTests() {
            clearResults();
            
            console.log('Starting comprehensive integration tests...');
            
            await testNavigationViews();
            await testReportActionFlow();
            await testHeatmapAndZones();
            await testPointsAndReset();
            await testEventCreationAndDisplay();
            await testResetFunctionality();
            
            console.log('All tests completed!');
            console.log(`Results: ${testResults.passed}/${testResults.total} passed`);
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            console.log('Page loaded. Click "Run All Tests" to start testing.');
        });
    </script>
</body>
</html>
